<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Download Test QA</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <script type="text/javascript" src="spec/helper.js"></script>

</head>
<body>
<!--<div>-->
<!--<br>-->
<!--<label>First name:-->
<!--<input type="text" id="filename" name="FileName" value="">-->
<!--</label><br>-->
<!--<button onclick="downloadFile()">download File update status with callback</button>-->
<!--<label id="progress"></label>-->
<!--</div>-->
<div>
    <br>
    <button onclick="downloadedFileExists()">Downloaded file exists</button>
</div>
<div>
    <br>
    <button onclick="downloadFile()">download File update status with callback</button>
    <label id="progress"></label>
</div>
<div>
    <br>
    <button onclick="uploadFile()">upload File</button>
    <label id="uploadProgress"></label>
</div>
<div>
    <br>
    <button onclick="listFiles()">list Files</button>
</div>
<div>
    <br>
    <button onclick="deleteFile()">Delete downloaded file</button>
</div>
<div>
    <br>
    <button onclick="downloadFileWithNotification()">download File update status with notification</button>
    <label id="notificationProgress"></label>
</div>
<div>
    <br>
    <button onclick="cancelDownload()">Cancel download</button>
</div>
<div>
    <br>
    <button onclick="cancelUpload()">Cancel upload</button>
</div>
<div id="rawResponse"></div>
</body>
<script>

    var fileName = "test100k.db";
    //    var fileName = "5MB.zip";
    var uploadPath = "http://www.csm-testcenter.org/test";
    //    var downloadPath = "http://speedtest.ftp.otenet.gr/files/"+fileName;
    var downloadPath = "http://speedtest.ftp.otenet.gr/files//"+fileName;


    //    function downloadFile() {
    //        updateInnerHTMLWithId("progress", "0");
    //        var body = {remotePath: downloadPath, progressScript: "downloadProgress"};
    //        sendPmapiRequest("storage/transfer/download", "POST", body);
    //    }
    function downloadFile() {
        updateInnerHTMLWithId("progress", "0");
//    var fileName = document.getElementById("filename").value;
//    console.log("filename = " + fileName);
        var body = {remotePath: downloadPath, progressScript: "downloadProgress"};
        sendPmapiRequest("storage/transfer/download", "POST", body);
    }

    function downloadFileWithNotification() {
        updateInnerHTMLWithId("notificationProgress", "0");
        var body = {remotePath: downloadPath};
        sendPmapiRequest("notify/events/FSMPTransferProgressNotification", "POST", {script: "downloadNotifyProgress"});
        sendPmapiRequest("storage/transfer/download", "POST", body);
    }

    function uploadFile() {
        updateInnerHTMLWithId("uploadProgress", "0");
        var body = {remotePath: uploadPath, progressScript: "uploadProgress"};
        sendPmapiRequest("storage/transfer/upload/" + fileName, "POST", body);
    }

    //    function downloadedFileExists() {
    //        sendPmapiRequest("storage/files/" + fileName, "GET", null);
    //    }
    function downloadedFileExists() {
//    var fileName = document.getElementById("filename").value;
//    console.log("filename = " + fileName);
        sendPmapiRequest("storage/files/" + fileName, "GET", null);
    }

    function listFiles() {
        sendPmapiRequest("storage/files", "GET", null);
    }

    function deleteFile() {
//    var customFileName = document.getElementById("filename").value;
//    if (customFileName != null) {
//      sendPmapiRequest("storage/files/" + customFileName, "DELETE", null);
//    } else {
        sendPmapiRequest("storage/files/" + fileName, "DELETE", null);
//    }
    }

    function cancelDownload() {
        var body = {remotePath: downloadPath};
        sendPmapiRequest("storage/transfer/cancel", "POST", body);
    }

    function cancelUpload() {
        var body = {remotePath: uploadPath};
        sendPmapiRequest("storage/transfer/cancel/" + fileName, "POST", body);
    }

    function downloadIsTransferring() {
        sendPmapiRequest("storage/transfer/active?remotePath="+downloadPath, "GET", null);
    }

    function uploadIsTransferring() {
        sendPmapiRequest("storage/transfer/active/"+fileName+"?remotePath="+uploadPath, "GET", null);
    }

    function downloadProgress(json) {
        updateInnerHTMLWithId("progress", json.transferPercentage);
    }

    function downloadNotifyProgress(json) {
        updateInnerHTMLWithId("notificationProgress", json.transferPercentage);
    }

    function uploadProgress(json) {
        updateInnerHTMLWithId("uploadProgress", json.transferPercentage);
    }

    function updateInnerHTMLWithId(id, content) {
        var currentContent = document.getElementById(id);
        currentContent.innerHTML = content;
    }

    function setRawResponseWithContent(jsonContent) {
        if (jsonContent == null) {
            updateInnerHTMLWithId("rawResponse", "")
        } else {
            updateInnerHTMLWithId("rawResponse", JSON.stringify(jsonContent));
        }
    }

    function clearRawResponseContent() {
        setRawResponseWithContent(null)
    }

    function sendPmapiRequest(uriPath, httpMethod, body, callback) {
        clearRawResponseContent();
        var http = new XMLHttpRequest();
        var url = "http://pmapi/" + uriPath;
        var params = null;
        if (body != null) {
            params = JSON.stringify(body);
        }

        http.onreadystatechange = function () {//Call a function when the state changes.
            if (http.readyState == 4 && http.status != 200) {
                console.log("error = " + http.error);
                console.log("status code = " + http.status);
                console.log("raw http = " + JSON.stringify(http))
            } else if (http.status == 200) {
                var response = http.responseText;
                var responseText = JSON.parse(response);
                if (callback != null) {
                    callback(responseText)
                } else {
                    setRawResponseWithContent(responseText)
                }
            }
        };

        http.open(httpMethod, url);
        http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        http.send(params);
    }
</script>
</html>
